<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments/template :: head(title=スタッフ用ページ)">
</head>

<style>
#modal, #qr_code {
	position: absolute;
}

#modal {
	left: 0;
	top: 0;
	background: rgba(0, 0, 0, 0.6);
	height: 100vh;
	width: 100%;
	display: none;
}

#qr_code {
	left: 50%;
	top: 50%;
	transform: translate(-50%, -50%);
}

canvas {
	width: 80vmin;
}

#staff_qr {
	width: 30px;
}
</style>

<body>
	<script>
		$(function() {
			var group = $("#group").text();

			var fn = {};
			fn.ajax = function(url, seat, success) {
				$.ajax({
					url : url,
					type : "POST",
					data : {
						group : group,
						seat : seat
					}
				}).done( data => success( data));
			}

			var timeout;
			var audio = new Audio("chime.mp3");

			fn.updateCalls = function( isUseingChime) {
				fn.ajax("/getCalls", "", function(calls) {
					$("#calls tr").not("#caption").remove();
					calls.forEach( function( call){
						var seat = call.seat;
						var time = call.callTime;

						var row = "<tr>";
						row += "<td>" + seat + "</td>";
						row += "<td>" + time + "</td>";
						row += "<td><button id='"+seat+"'>削除</button></td>";
						row += "</tr>";
						$("#calls").append(row);

						var message = "対応済みとして「" + seat + "」を削除しますか？";
						const updateCalls = () => fn.updateCalls( false);
						const deleteCall = () => fn.ajax( "deleteCall", seat, updateCalls);
						$("#" + seat).on("click", () => confirm( message) && deleteCall());
					});

					clearTimeout(timeout);
					timeout = setTimeout( () => fn.updateCalls( true), 30000);

					if( isUseingChime && calls.length > 0 && $("#chime_check").is(":checked")){
						audio.play();
					}
				});
			}

			fn.updateCalls( false);

			$("#staff_qr").on("click", function(){
				var url = $("#url").text() + group;
				$("#qr_code").html("");
				$("#qr_code").qrcode({text:url});
				$("#modal").fadeIn();
			});
			$("#modal").on( "click", () => $("#modal").fadeOut());
		});
	</script>

	<h1>スタッフ呼出順簡易管理システム</h1>
	<h2>
		スタッフ用ページ<img id="staff_qr" src="qr_code.png" />
	</h2>

	<p>
		グループID <span id="group" th:text="${group}"></span>
	</p>
	<p>
		<input id="chime_check" type="checkbox" /> <label for="chime_check">呼出発生時にチャイムを鳴らす</label>
	</p>

	<table id="calls">
		<tr id="caption">
			<th>座席番号</th>
			<th>呼出時刻</th>
			<th>-</th>
		</tr>
	</table>

	<span id="url" th:text="${staff}" style="display: none;"></span>

	<div id="modal">
		<div id="qr_code"></div>
	</div>

</body>
</html>